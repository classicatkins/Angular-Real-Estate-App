import { ChangeDetectionStrategy, Component, EventEmitter, HostListener, ViewChild, ViewEncapsulation } from "@angular/core";
import { NgStyle, NgClass, NgIf } from "@angular/common";
import { NgxPopperjsTriggers } from "../../models/ngx-popperjs-triggers.model";
//
import { computePosition, autoUpdate, flip, arrow, limitShift, shift, offset, autoPlacement, } from "@floating-ui/dom";
import { fromEvent, Subject, takeUntil } from "rxjs";
import * as i0 from "@angular/core";
export class NgxPopperjsContentComponent {
    elRef;
    _viewRef;
    _changeDetectorRef;
    static nextId = 0;
    ariaHidden;
    arrowColor = null;
    displayType;
    id = `ngx_poppperjs_${++NgxPopperjsContentComponent.nextId}`;
    isMouseOver = !1;
    onHidden = new EventEmitter();
    onUpdate;
    opacity;
    popperInstance;
    popperOptions = {
        disableAnimation: false,
        disableDefaultStyling: false,
        boundariesElement: "",
        trigger: NgxPopperjsTriggers.hover,
        positionFixed: false,
        appendToBody: false,
        popperModifiers: []
    };
    popperViewRef;
    referenceObject;
    state;
    text;
    _destroy$ = new Subject();
    _resizeCtrl$ = new Subject();
    _styleId = `${this.id}_style`;
    constructor(elRef, _viewRef, _changeDetectorRef) {
        this.elRef = elRef;
        this._viewRef = _viewRef;
        this._changeDetectorRef = _changeDetectorRef;
        this._toggleVisibility(!1);
    }
    clean() {
        this.toggleVisibility(false);
        if (!this.popperInstance) {
            return;
        }
        this.popperInstance();
    }
    extractAppliedClassListExpr(classList = []) {
        const klassList = Array.isArray(classList) ? classList : typeof classList === typeof "" ? classList.replace(/ /, "").split(",") : [];
        return klassList.reduce((acc, klass) => {
            acc[klass] = !0;
            return acc;
        }, {});
    }
    hide() {
        if (this.popperInstance) {
            this.popperInstance();
        }
        this.toggleVisibility(!1);
        this.onHidden.emit();
    }
    ngOnDestroy() {
        this._destroy$.next();
        this.clean();
        if (this.popperOptions.appendTo && this.elRef && this.elRef.nativeElement && this.elRef.nativeElement.parentNode) {
            this._viewRef.detach();
            this.elRef.nativeElement.parentNode.removeChild(this.elRef.nativeElement);
        }
    }
    onDocumentResize() {
        this.update();
    }
    onMouseOver() {
        this.isMouseOver = true;
    }
    show() {
        if (!this.referenceObject) {
            return;
        }
        this._resizeCtrl$.next();
        this._determineArrowColor();
        this.popperInstance = autoUpdate(this.referenceObject, this.popperViewRef.nativeElement, () => {
            this._computePosition();
        });
        fromEvent(document, "resize")
            .pipe(takeUntil(this._resizeCtrl$), takeUntil(this._destroy$))
            .subscribe({
            next: () => this.onDocumentResize()
        });
    }
    showOnLeave() {
        this.isMouseOver = false;
        if (this.popperOptions.trigger !== NgxPopperjsTriggers.hover && !this.popperOptions.hideOnMouseLeave) {
            return;
        }
        this.hide();
    }
    // Toggle visibility and detect changes - Run only after ngOnInit!
    toggleVisibility(state) {
        this._toggleVisibility(state);
        // tslint:disable-next-line:no-string-literal
        if (!this._changeDetectorRef["destroyed"]) {
            this._changeDetectorRef.detectChanges();
        }
    }
    update() {
        this._computePosition();
    }
    _computePosition() {
        const appendToParent = this.popperOptions.appendTo && document.querySelector(this.popperOptions.appendTo);
        if (appendToParent && this.elRef.nativeElement.parentNode !== appendToParent) {
            this.elRef.nativeElement.parentNode && this.elRef.nativeElement.parentNode.removeChild(this.elRef.nativeElement);
            appendToParent.appendChild(this.elRef.nativeElement);
        }
        const arrowElement = this.elRef.nativeElement.querySelector(".ngxp__arrow");
        const arrowLen = arrowElement.offsetWidth;
        // Get half the arrow box's hypotenuse length
        const floatingOffset = Math.sqrt(2 * arrowLen ** 2) / 2;
        const boundaryMiddleware = [];
        if (this.popperOptions.flip) {
            boundaryMiddleware.push(flip());
        }
        if (this.popperOptions.preventOverflow) {
            boundaryMiddleware.push(shift({ limiter: limitShift() }));
        }
        const popperOptions = {
            placement: this.popperOptions.placement,
            strategy: this.popperOptions.positionFixed ? "fixed" : "absolute",
            middleware: [
                offset(floatingOffset),
                ...boundaryMiddleware,
                arrow({
                    element: arrowElement,
                    padding: 4
                })
            ],
        };
        if (!this.popperOptions.preventOverflow && !popperOptions.placement) {
            const boundariesElement = this.popperOptions.boundariesElement && document.querySelector(this.popperOptions.boundariesElement);
            popperOptions.middleware.push(autoPlacement({
                boundary: boundariesElement
            }));
        }
        computePosition(this.referenceObject, this.popperViewRef.nativeElement, popperOptions)
            .then(({ middlewareData, x, y, placement }) => {
            const side = placement.split("-")[0];
            this.popperViewRef.nativeElement.setAttribute("data-popper-placement", side);
            if (middlewareData.arrow) {
                const staticSide = {
                    top: "bottom",
                    right: "left",
                    bottom: "top",
                    left: "right"
                }[side];
                Object.assign(arrowElement.style, {
                    left: middlewareData.arrow.x != null ? `${middlewareData.arrow.x}px` : "",
                    top: middlewareData.arrow.y != null ? `${middlewareData.arrow.y}px` : "",
                    [staticSide]: `${-arrowLen / 2}px`
                });
            }
            Object.assign(this.popperViewRef.nativeElement.style, {
                left: `${x}px`,
                top: `${y}px`,
            });
            this.toggleVisibility(!0);
            this.onUpdate?.();
        });
    }
    _createArrowSelector() {
        return `div#${this.id}.ngxp__container > .ngxp__arrow.ngxp__force-arrow`;
    }
    _determineArrowColor() {
        if (!this.popperOptions.styles || this.arrowColor) {
            return !1;
        }
        const ruleValue = this.popperOptions.styles["background-color"] || this.popperOptions.styles.backgroundColor;
        if (this.arrowColor === ruleValue) {
            return !1;
        }
        this.arrowColor = ruleValue;
        let $style = document.querySelector(`#${this._styleId}`);
        const styleContent = this.arrowColor ?
            `${this._createArrowSelector()}:before { background-color: ${this.arrowColor}; }` : "";
        if (!$style) {
            $style = document.createElement("style");
            $style.id = this._styleId;
            $style.setAttribute("type", "text/css");
            document.head.appendChild($style);
        }
        // tslint:disable-next-line:no-string-literal
        if ($style["styleSheet"]) {
            // tslint:disable-next-line:no-string-literal
            $style["styleSheet"].cssText = styleContent;
            // This is required for IE8 and below.
        }
        else {
            $style.innerHTML = styleContent;
        }
    }
    _toggleVisibility(state) {
        this.displayType = ["none", "block"][+state];
        this.opacity = +state;
        this.ariaHidden = `${!state}`;
        this.state = state;
    }
    /** @nocollapse */ static ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "17.0.0", ngImport: i0, type: NgxPopperjsContentComponent, deps: [{ token: i0.ElementRef }, { token: i0.ViewContainerRef }, { token: i0.ChangeDetectorRef }], target: i0.ɵɵFactoryTarget.Component });
    /** @nocollapse */ static ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "14.0.0", version: "17.0.0", type: NgxPopperjsContentComponent, isStandalone: true, selector: "popper-content", host: { listeners: { "mouseover": "onMouseOver()", "mouseleave": "showOnLeave()" } }, viewQueries: [{ propertyName: "popperViewRef", first: true, predicate: ["popperViewRef"], descendants: true, static: true }], exportAs: ["ngxPopperjsContent"], ngImport: i0, template: "<div #popperViewRef\r\n     [attr.id]=\"id\"\r\n     [class.ngxp__container]=\"!popperOptions.disableDefaultStyling\"\r\n     [class.ngxp__animation]=\"!popperOptions.disableAnimation\"\r\n     [style.display]=\"displayType\"\r\n     [style.opacity]=\"opacity\"\r\n     [ngStyle]=\"popperOptions.styles\"\r\n     [ngClass]=\"extractAppliedClassListExpr(popperOptions.applyClass)\"\r\n     attr.aria-hidden=\"{{ariaHidden}}\"\r\n     [attr.aria-describedby]=\"popperOptions.ariaDescribe || null\"\r\n     attr.role=\"{{popperOptions.ariaRole}}\">\r\n    <div *ngIf=\"text\"\r\n         class=\"ngxp__inner\"\r\n         [innerHTML]=\"text\">\r\n        <ng-content></ng-content>\r\n    </div>\r\n    <div *ngIf=\"!text\"\r\n         class=\"ngxp__inner\">\r\n        <ng-content></ng-content>\r\n    </div>\r\n    <div class=\"ngxp__arrow\"\r\n         [class.ngxp__force-arrow]=\"arrowColor\"\r\n         [ngClass]=\"extractAppliedClassListExpr(popperOptions.applyArrowClass)\"></div>\r\n\r\n</div>\r\n", styles: ["popper-content{position:relative;display:block}.ngxp__container{display:none;position:absolute;border-radius:3px;border:1px solid grey;box-shadow:0 0 2px #00000080;padding:10px}.ngxp__container.ngxp__animation{animation:ngxp-fadeIn .15s ease-out}.ngxp__container>.ngxp__arrow{position:absolute;width:10px;height:10px;z-index:-1;transform:rotate(45deg);background-color:red}.ngxp__container[data-popper-placement^=top]>.ngxp__arrow{bottom:-5px}.ngxp__container[data-popper-placement^=bottom]>.ngxp__arrow{top:-5px}.ngxp__container[data-popper-placement^=left]>.ngxp__arrow{right:-5px}.ngxp__container[data-popper-placement^=right]>.ngxp__arrow{left:-5px}@keyframes ngxp-fadeIn{0%{display:none;opacity:0}1%{display:block;opacity:0}to{display:block;opacity:1}}\n"], dependencies: [{ kind: "directive", type: NgStyle, selector: "[ngStyle]", inputs: ["ngStyle"] }, { kind: "directive", type: NgClass, selector: "[ngClass]", inputs: ["class", "ngClass"] }, { kind: "directive", type: NgIf, selector: "[ngIf]", inputs: ["ngIf", "ngIfThen", "ngIfElse"] }], changeDetection: i0.ChangeDetectionStrategy.OnPush, encapsulation: i0.ViewEncapsulation.None });
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "17.0.0", ngImport: i0, type: NgxPopperjsContentComponent, decorators: [{
            type: Component,
            args: [{ selector: "popper-content", encapsulation: ViewEncapsulation.None, changeDetection: ChangeDetectionStrategy.OnPush, exportAs: "ngxPopperjsContent", standalone: true, imports: [NgStyle, NgClass, NgIf], template: "<div #popperViewRef\r\n     [attr.id]=\"id\"\r\n     [class.ngxp__container]=\"!popperOptions.disableDefaultStyling\"\r\n     [class.ngxp__animation]=\"!popperOptions.disableAnimation\"\r\n     [style.display]=\"displayType\"\r\n     [style.opacity]=\"opacity\"\r\n     [ngStyle]=\"popperOptions.styles\"\r\n     [ngClass]=\"extractAppliedClassListExpr(popperOptions.applyClass)\"\r\n     attr.aria-hidden=\"{{ariaHidden}}\"\r\n     [attr.aria-describedby]=\"popperOptions.ariaDescribe || null\"\r\n     attr.role=\"{{popperOptions.ariaRole}}\">\r\n    <div *ngIf=\"text\"\r\n         class=\"ngxp__inner\"\r\n         [innerHTML]=\"text\">\r\n        <ng-content></ng-content>\r\n    </div>\r\n    <div *ngIf=\"!text\"\r\n         class=\"ngxp__inner\">\r\n        <ng-content></ng-content>\r\n    </div>\r\n    <div class=\"ngxp__arrow\"\r\n         [class.ngxp__force-arrow]=\"arrowColor\"\r\n         [ngClass]=\"extractAppliedClassListExpr(popperOptions.applyArrowClass)\"></div>\r\n\r\n</div>\r\n", styles: ["popper-content{position:relative;display:block}.ngxp__container{display:none;position:absolute;border-radius:3px;border:1px solid grey;box-shadow:0 0 2px #00000080;padding:10px}.ngxp__container.ngxp__animation{animation:ngxp-fadeIn .15s ease-out}.ngxp__container>.ngxp__arrow{position:absolute;width:10px;height:10px;z-index:-1;transform:rotate(45deg);background-color:red}.ngxp__container[data-popper-placement^=top]>.ngxp__arrow{bottom:-5px}.ngxp__container[data-popper-placement^=bottom]>.ngxp__arrow{top:-5px}.ngxp__container[data-popper-placement^=left]>.ngxp__arrow{right:-5px}.ngxp__container[data-popper-placement^=right]>.ngxp__arrow{left:-5px}@keyframes ngxp-fadeIn{0%{display:none;opacity:0}1%{display:block;opacity:0}to{display:block;opacity:1}}\n"] }]
        }], ctorParameters: () => [{ type: i0.ElementRef }, { type: i0.ViewContainerRef }, { type: i0.ChangeDetectorRef }], propDecorators: { popperViewRef: [{
                type: ViewChild,
                args: ["popperViewRef", { static: !0 }]
            }], onMouseOver: [{
                type: HostListener,
                args: ["mouseover"]
            }], showOnLeave: [{
                type: HostListener,
                args: ["mouseleave"]
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmd4LXBvcHBlcmpzLWNvbnRlbnQuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvbmd4LXBvcHBlcmpzL3NyYy9saWIvY29tcG9uZW50cy9uZ3gtcG9wcGVyanMtY29udGVudC9uZ3gtcG9wcGVyanMtY29udGVudC5jb21wb25lbnQudHMiLCIuLi8uLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9uZ3gtcG9wcGVyanMvc3JjL2xpYi9jb21wb25lbnRzL25neC1wb3BwZXJqcy1jb250ZW50L25neC1wb3BwZXJqcy1jb250ZW50LmNvbXBvbmVudC5odG1sIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFDSCx1QkFBdUIsRUFFdkIsU0FBUyxFQUVULFlBQVksRUFDWixZQUFZLEVBRVosU0FBUyxFQUVULGlCQUFpQixFQUNwQixNQUFNLGVBQWUsQ0FBQztBQUN2QixPQUFPLEVBQUMsT0FBTyxFQUFFLE9BQU8sRUFBRSxJQUFJLEVBQUMsTUFBTSxpQkFBaUIsQ0FBQztBQUd2RCxPQUFPLEVBQUMsbUJBQW1CLEVBQUMsTUFBTSwwQ0FBMEMsQ0FBQztBQUM3RSxFQUFFO0FBQ0YsT0FBTyxFQUNILGVBQWUsRUFDZixVQUFVLEVBQ1YsSUFBSSxFQUNKLEtBQUssRUFDTCxVQUFVLEVBQ1YsS0FBSyxFQUNMLE1BQU0sRUFDTixhQUFhLEdBQ2hCLE1BQU0sa0JBQWtCLENBQUM7QUFDMUIsT0FBTyxFQUFDLFNBQVMsRUFBRSxPQUFPLEVBQUUsU0FBUyxFQUFDLE1BQU0sTUFBTSxDQUFDOztBQWFuRCxNQUFNLE9BQU8sMkJBQTJCO0lBZ0NqQjtJQUNHO0lBQ0E7SUFoQ3RCLE1BQU0sQ0FBQyxNQUFNLEdBQVcsQ0FBQyxDQUFDO0lBRTFCLFVBQVUsQ0FBUztJQUNuQixVQUFVLEdBQWtCLElBQUksQ0FBQztJQUNqQyxXQUFXLENBQVM7SUFDcEIsRUFBRSxHQUFXLGlCQUFpQixFQUFFLDJCQUEy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WUFBWSxDQUFDO1lBQzVDLHNDQUFzQztTQUN6QzthQUNJO1lBQ0QsTUFBTSxDQUFDLFNBQVMsR0FBRyxZQUFZLENBQUM7U0FDbkM7SUFDTCxDQUFDO0lBRVMsaUJBQWlCLENBQUMsS0FBSztRQUM3QixJQUFJLENBQUMsV0FBVyxHQUFHLENBQUMsTUFBTSxFQUFFLE9BQU8sQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDN0MsSUFBSSxDQUFDLE9BQU8sR0FBRyxDQUFDLEtBQUssQ0FBQztRQUN0QixJQUFJLENBQUMsVUFBVSxHQUFHLEdBQUcsQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUM5QixJQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQztJQUN2QixDQUFDOzBIQXRPUSwyQkFBMkI7OEdBQTNCLDJCQUEyQixnVUN4Q3hDLDQrQkF5QkEsaXpCRGFjLE9BQU8sMkVBQUUsT0FBTyxvRkFBRSxJQUFJOzsyRkFFdkIsMkJBQTJCO2tCQVh2QyxTQUFTOytCQUVJLGdCQUFnQixpQkFDWCxpQkFBaUIsQ0FBQyxJQUFJLG1CQUNwQix1QkFBdUIsQ0FBQyxNQUFNLFlBR3JDLG9CQUFvQixjQUNsQixJQUFJLFdBQ1AsQ0FBQyxPQUFPLEVBQUUsT0FBTyxFQUFFLElBQUksQ0FBQzs4SUF5QmpDLGFBQWE7c0JBRFosU0FBUzt1QkFBQyxlQUFlLEVBQUUsRUFBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDLEVBQUM7Z0JBd0R4QyxXQUFXO3NCQURWLFlBQVk7dUJBQUMsV0FBVztnQkE2QnpCLFdBQVc7c0JBRFYsWUFBWTt1QkFBQyxZQUFZIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcclxuICAgIENoYW5nZURldGVjdGlvblN0cmF0ZWd5LFxyXG4gICAgQ2hhbmdlRGV0ZWN0b3JSZWYsXHJcbiAgICBDb21wb25lbnQsXHJcbiAgICBFbGVtZW50UmVmLFxyXG4gICAgRXZlbnRFbWl0dGVyLFxyXG4gICAgSG9zdExpc3RlbmVyLFxyXG4gICAgT25EZXN0cm95LFxyXG4gICAgVmlld0NoaWxkLFxyXG4gICAgVmlld0NvbnRhaW5lclJlZixcclxuICAgIFZpZXdFbmNhcHN1bGF0aW9uXHJcbn0gZnJvbSBcIkBhbmd1bGFyL2NvcmVcIjtcclxuaW1wb3J0IHtOZ1N0eWxlLCBOZ0NsYXNzLCBOZ0lmfSBmcm9tIFwiQGFuZ3VsYXIvY29tbW9uXCI7XHJcbi8vXHJcbmltcG9ydCB7Tmd4UG9wcGVyanNPcHRpb25zfSBmcm9tIFwiLi4vLi4vbW9kZWxzL25neC1wb3BwZXJqcy1vcHRpb25zLm1vZGVsXCI7XHJcbmltcG9ydCB7Tmd4UG9wcGVyanNUcmlnZ2Vyc30gZnJvbSBcIi4uLy4uL21vZGVscy9uZ3gtcG9wcGVyanMtdHJpZ2dlcnMubW9kZWxcIjtcclxuLy9cclxuaW1wb3J0IHtcclxuICAgIGNvbXB1dGVQb3NpdGlvbixcclxuICAgIGF1dG9VcGRhdGUsXHJcbiAgICBmbGlwLFxyXG4gICAgYXJyb3csXHJcbiAgICBsaW1pdFNoaWZ0LFxyXG4gICAgc2hpZnQsXHJcbiAgICBvZmZzZXQsXHJcbiAgICBhdXRvUGxhY2VtZW50LCBDb21wdXRlUG9zaXRpb25Db25maWcsXHJcbn0gZnJvbSBcIkBmbG9hdGluZy11aS9kb21cIjtcclxuaW1wb3J0IHtmcm9tRXZlbnQsIFN1YmplY3QsIHRha2VVbnRpbH0gZnJvbSBcInJ4anNcIjtcclxuXHJcbkBDb21wb25lbnQoe1xyXG4gICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOmNvbXBvbmVudC1zZWxlY3RvclxyXG4gICAgc2VsZWN0b3I6IFwicG9wcGVyLWNvbnRlbnRcIixcclxuICAgIGVuY2Fwc3VsYXRpb246IFZpZXdFbmNhcHN1bGF0aW9uLk5vbmUsXHJcbiAgICBjaGFuZ2VEZXRlY3Rpb246IENoYW5nZURldGVjdGlvblN0cmF0ZWd5Lk9uUHVzaCxcclxuICAgIHRlbXBsYXRlVXJsOiBcIi4vbmd4LXBvcHBlcmpzLWNvbnRlbnQuY29tcG9uZW50Lmh0bWxcIixcclxuICAgIHN0eWxlVXJsczogW1wiLi9uZ3gtcG9wcGVyanMtY29udGVudC5jb21wb25lbnQuc2Nzc1wiXSxcclxuICAgIGV4cG9ydEFzOiBcIm5neFBvcHBlcmpzQ29udGVudFwiLFxyXG4gICAgc3RhbmRhbG9uZTogdHJ1ZSxcclxuICAgIGltcG9ydHM6IFtOZ1N0eWxlLCBOZ0NsYXNzLCBOZ0lmXVxyXG59KVxyXG5leHBvcnQgY2xhc3MgTmd4UG9wcGVyanNDb250ZW50Q29tcG9uZW50IGltcGxlbWVudHMgT25EZXN0cm95IHtcclxuXHJcbiAgICBzdGF0aWMgbmV4dElkOiBudW1iZXIgPSAwO1xyXG5cclxuICAgIGFyaWFIaWRkZW46IHN0cmluZztcclxuICAgIGFycm93Q29sb3I6IHN0cmluZyB8IG51bGwgPSBudWxsO1xyXG4gICAgZGlzcGxheVR5cGU6IHN0cmluZztcclxuICAgIGlkOiBzdHJpbmcgPSBgbmd4X3BvcHBwZXJqc18keysrTmd4UG9wcGVyanNDb250ZW50Q29tcG9uZW50Lm5leHRJZH1gO1xyXG4gICAgaXNNb3VzZU92ZXI6IGJvb2xlYW4gPSAhMTtcclxuICAgIG9uSGlkZGVuID0gbmV3IEV2ZW50RW1pdHRlcigpO1xyXG4gICAgb25VcGRhdGU6ICgpID0+IGFueTtcclxuICAgIG9wYWNpdHk6IG51bWJlcjtcclxuICAgIHBvcHBlckluc3RhbmNlOiAoKSA9PiB2b2lkO1xyXG4gICAgcG9wcGVyT3B0aW9uczogTmd4UG9wcGVyanNPcHRpb25zID0ge1xyXG4gICAgICAgIGRpc2FibGVBbmltYXRpb246IGZhbHNlLFxyXG4gICAgICAgIGRpc2FibGVEZWZhdWx0U3R5bGluZzogZmFsc2UsXHJcbiAgICAgICAgYm91bmRhcmllc0VsZW1lbnQ6IFwiXCIsXHJcbiAgICAgICAgdHJpZ2dlcjogTmd4UG9wcGVyanNUcmlnZ2Vycy5ob3ZlcixcclxuICAgICAgICBwb3NpdGlvbkZpeGVkOiBmYWxzZSxcclxuICAgICAgICBhcHBlbmRUb0JvZHk6IGZhbHNlLFxyXG4gICAgICAgIHBvcHBlck1vZGlmaWVyczogW11cclxuICAgIH0gYXMgTmd4UG9wcGVyanNPcHRpb25zO1xyXG4gICAgQFZpZXdDaGlsZChcInBvcHBlclZpZXdSZWZcIiwge3N0YXRpYzogITB9KVxyXG4gICAgcG9wcGVyVmlld1JlZjogRWxlbWVudFJlZjtcclxuICAgIHJlZmVyZW5jZU9iamVjdDogSFRNTEVsZW1lbnQ7XHJcbiAgICBzdGF0ZTogYm9vbGVhbjtcclxuICAgIHRleHQ6IHN0cmluZztcclxuXHJcbiAgICBwcm90ZWN0ZWQgX2Rlc3Ryb3kkOiBTdWJqZWN0PHZvaWQ+ID0gbmV3IFN1YmplY3Q8dm9pZD4oKTtcclxuICAgIHByb3RlY3RlZCBfcmVzaXplQ3RybCQ6IFN1YmplY3Q8dm9pZD4gPSBuZXcgU3ViamVjdDx2b2lkPigpO1xyXG4gICAgcHJvdGVjdGVkIF9zdHlsZUlkID0gYCR7dGhpcy5pZH1fc3R5bGVgO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKHB1YmxpYyBlbFJlZjogRWxlbWVudFJlZixcclxuICAgICAgICAgICAgICAgIHByb3RlY3RlZCBfdmlld1JlZjogVmlld0NvbnRhaW5lclJlZixcclxuICAgICAgICAgICAgICAgIHByb3RlY3RlZCBfY2hhbmdlRGV0ZWN0b3JSZWY6IENoYW5nZURldGVjdG9yUmVmKSB7XHJcbiAgICAgICAgdGhpcy5fdG9nZ2xlVmlzaWJpbGl0eSghMSk7XHJcbiAgICB9XHJcblxyXG4gICAgY2xlYW4oKSB7XHJcbiAgICAgICAgdGhpcy50b2dnbGVWaXNpYmlsaXR5KGZhbHNlKTtcclxuICAgICAgICBpZiAoIXRoaXMucG9wcGVySW5zdGFuY2UpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLnBvcHBlckluc3RhbmNlKCk7XHJcbiAgICB9XHJcblxyXG4gICAgZXh0cmFjdEFwcGxpZWRDbGFzc0xpc3RFeHByKGNsYXNzTGlzdDogc3RyaW5nIHwgc3RyaW5nW10gPSBbXSk6IG9iamVjdCB7XHJcbiAgICAgICAgY29uc3Qga2xhc3NMaXN0ID0gQXJyYXkuaXNBcnJheShjbGFzc0xpc3QpID8gY2xhc3NMaXN0IDogdHlwZW9mIGNsYXNzTGlzdCA9PT0gdHlwZW9mIFwiXCIgPyBjbGFzc0xpc3QucmVwbGFjZSgvIC8sIFwiXCIpLnNwbGl0KFwiLFwiKSA6IFtdO1xyXG5cclxuICAgICAgICByZXR1cm4ga2xhc3NMaXN0LnJlZHVjZSgoYWNjLCBrbGFzcykgPT4ge1xyXG4gICAgICAgICAgICBhY2Nba2xhc3NdID0gITA7XHJcblxyXG4gICAgICAgICAgICByZXR1cm4gYWNjO1xyXG4gICAgICAgIH0sIHt9KTtcclxuICAgIH1cclxuXHJcbiAgICBoaWRlKCk6IHZvaWQge1xyXG4gICAgICAgIGlmICh0aGlzLnBvcHBlckluc3RhbmNlKSB7XHJcbiAgICAgICAgICAgIHRoaXMucG9wcGVySW5zdGFuY2UoKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy50b2dnbGVWaXNpYmlsaXR5KCExKTtcclxuICAgICAgICB0aGlzLm9uSGlkZGVuLmVtaXQoKTtcclxuICAgIH1cclxuXHJcbiAgICBuZ09uRGVzdHJveSgpIHtcclxuICAgICAgICB0aGlzLl9kZXN0cm95JC5uZXh0KCk7XHJcbiAgICAgICAgdGhpcy5jbGVhbigpO1xyXG4gICAgICAgIGlmICh0aGlzLnBvcHBlck9wdGlvbnMuYXBwZW5kVG8gJiYgdGhpcy5lbFJlZiAmJiB0aGlzLmVsUmVmLm5hdGl2ZUVsZW1lbnQgJiYgdGhpcy5lbFJlZi5uYXRpdmVFbGVtZW50LnBhcmVudE5vZGUpIHtcclxuICAgICAgICAgICAgdGhpcy5fdmlld1JlZi5kZXRhY2goKTtcclxuICAgICAgICAgICAgdGhpcy5lbFJlZi5uYXRpdmVFbGVtZW50LnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQodGhpcy5lbFJlZi5uYXRpdmVFbGVtZW50KTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgb25Eb2N1bWVudFJlc2l6ZSgpIHtcclxuICAgICAgICB0aGlzLnVwZGF0ZSgpO1xyXG4gICAgfVxyXG5cclxuICAgIEBIb3N0TGlzdGVuZXIoXCJtb3VzZW92ZXJcIilcclxuICAgIG9uTW91c2VPdmVyKCkge1xyXG4gICAgICAgIHRoaXMuaXNNb3VzZU92ZXIgPSB0cnVlO1xyXG4gICAgfVxyXG5cclxuICAgIHNob3coKTogdm9pZCB7XHJcbiAgICAgICAgaWYgKCF0aGlzLnJlZmVyZW5jZU9iamVjdCkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuX3Jlc2l6ZUN0cmwkLm5leHQoKTtcclxuICAgICAgICB0aGlzLl9kZXRlcm1pbmVBcnJvd0NvbG9yKCk7XHJcbiAgICAgICAgdGhpcy5wb3BwZXJJbnN0YW5jZSA9IGF1dG9VcGRhdGUoXHJcbiAgICAgICAgICAgIHRoaXMucmVmZXJlbmNlT2JqZWN0LFxyXG4gICAgICAgICAgICB0aGlzLnBvcHBlclZpZXdSZWYubmF0aXZlRWxlbWVudCxcclxuICAgICAgICAgICAgKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5fY29tcHV0ZVBvc2l0aW9uKCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICApO1xyXG4gICAgICAgIGZyb21FdmVudChkb2N1bWVudCwgXCJyZXNpemVcIilcclxuICAgICAgICAgICAgLnBpcGUoXHJcbiAgICAgICAgICAgICAgICB0YWtlVW50aWwodGhpcy5fcmVzaXplQ3RybCQpLFxyXG4gICAgICAgICAgICAgICAgdGFrZVVudGlsKHRoaXMuX2Rlc3Ryb3kkKSxcclxuICAgICAgICAgICAgKVxyXG4gICAgICAgICAgICAuc3Vic2NyaWJlKHtcclxuICAgICAgICAgICAgICAgIG5leHQ6ICgpID0+IHRoaXMub25Eb2N1bWVudFJlc2l6ZSgpXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIEBIb3N0TGlzdGVuZXIoXCJtb3VzZWxlYXZlXCIpXHJcbiAgICBzaG93T25MZWF2ZSgpIHtcclxuICAgICAgICB0aGlzLmlzTW91c2VPdmVyID0gZmFsc2U7XHJcbiAgICAgICAgaWYgKHRoaXMucG9wcGVyT3B0aW9ucy50cmlnZ2VyICE9PSBOZ3hQb3BwZXJqc1RyaWdnZXJzLmhvdmVyICYmICF0aGlzLnBvcHBlck9wdGlvbnMuaGlkZU9uTW91c2VMZWF2ZSkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuaGlkZSgpO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIFRvZ2dsZSB2aXNpYmlsaXR5IGFuZCBkZXRlY3QgY2hhbmdlcyAtIFJ1biBvbmx5IGFmdGVyIG5nT25Jbml0IVxyXG4gICAgdG9nZ2xlVmlzaWJpbGl0eShzdGF0ZTogYm9vbGVhbik6IHZvaWQge1xyXG4gICAgICAgIHRoaXMuX3RvZ2dsZVZpc2liaWxpdHkoc3RhdGUpO1xyXG4gICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1zdHJpbmctbGl0ZXJhbFxyXG4gICAgICAgIGlmICghdGhpcy5fY2hhbmdlRGV0ZWN0b3JSZWZbXCJkZXN0cm95ZWRcIl0pIHtcclxuICAgICAgICAgICAgdGhpcy5fY2hhbmdlRGV0ZWN0b3JSZWYuZGV0ZWN0Q2hhbmdlcygpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICB1cGRhdGUoKTogdm9pZCB7XHJcbiAgICAgICAgdGhpcy5fY29tcHV0ZVBvc2l0aW9uKCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJvdGVjdGVkIF9jb21wdXRlUG9zaXRpb24oKTogdm9pZCB7XHJcbiAgICAgICAgY29uc3QgYXBwZW5kVG9QYXJlbnQgPSB0aGlzLnBvcHBlck9wdGlvbnMuYXBwZW5kVG8gJiYgZG9jdW1lbnQucXVlcnlTZWxlY3Rvcih0aGlzLnBvcHBlck9wdGlvbnMuYXBwZW5kVG8pO1xyXG4gICAgICAgIGlmIChhcHBlbmRUb1BhcmVudCAmJiB0aGlzLmVsUmVmLm5hdGl2ZUVsZW1lbnQucGFyZW50Tm9kZSAhPT0gYXBwZW5kVG9QYXJlbnQpIHtcclxuICAgICAgICAgICAgdGhpcy5lbFJlZi5uYXRpdmVFbGVtZW50LnBhcmVudE5vZGUgJiYgdGhpcy5lbFJlZi5uYXRpdmVFbGVtZW50LnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQodGhpcy5lbFJlZi5uYXRpdmVFbGVtZW50KTtcclxuICAgICAgICAgICAgYXBwZW5kVG9QYXJlbnQuYXBwZW5kQ2hpbGQodGhpcy5lbFJlZi5uYXRpdmVFbGVtZW50KTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IGFycm93RWxlbWVudCA9IHRoaXMuZWxSZWYubmF0aXZlRWxlbWVudC5xdWVyeVNlbGVjdG9yKFwiLm5neHBfX2Fycm93XCIpO1xyXG4gICAgICAgIGNvbnN0IGFycm93TGVuID0gYXJyb3dFbGVtZW50Lm9mZnNldFdpZHRoO1xyXG4gICAgICAgIC8vIEdldCBoYWxmIHRoZSBhcnJvdyBib3gncyBoeXBvdGVudXNlIGxlbmd0aFxyXG4gICAgICAgIGNvbnN0IGZsb2F0aW5nT2Zmc2V0ID0gTWF0aC5zcXJ0KDIgKiBhcnJvd0xlbiAqKiAyKSAvIDI7XHJcbiAgICAgICAgY29uc3QgYm91bmRhcnlNaWRkbGV3YXJlID0gW107XHJcbiAgICAgICAgaWYgKHRoaXMucG9wcGVyT3B0aW9ucy5mbGlwKSB7XHJcbiAgICAgICAgICAgIGJvdW5kYXJ5TWlkZGxld2FyZS5wdXNoKGZsaXAoKSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICh0aGlzLnBvcHBlck9wdGlvbnMucHJldmVudE92ZXJmbG93KSB7XHJcbiAgICAgICAgICAgIGJvdW5kYXJ5TWlkZGxld2FyZS5wdXNoKHNoaWZ0KHtsaW1pdGVyOiBsaW1pdFNoaWZ0KCl9KSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IHBvcHBlck9wdGlvbnM6IFBhcnRpYWw8Q29tcHV0ZVBvc2l0aW9uQ29uZmlnPiA9IHtcclxuICAgICAgICAgICAgcGxhY2VtZW50OiB0aGlzLnBvcHBlck9wdGlvbnMucGxhY2VtZW50LFxyXG4gICAgICAgICAgICBzdHJhdGVneTogdGhpcy5wb3BwZXJPcHRpb25zLnBvc2l0aW9uRml4ZWQgPyBcImZpeGVkXCIgOiBcImFic29sdXRlXCIsXHJcbiAgICAgICAgICAgIG1pZGRsZXdhcmU6IFtcclxuICAgICAgICAgICAgICAgIG9mZnNldChmbG9hdGluZ09mZnNldCksXHJcbiAgICAgICAgICAgICAgICAuLi5ib3VuZGFyeU1pZGRsZXdhcmUsXHJcbiAgICAgICAgICAgICAgICBhcnJvdyh7XHJcbiAgICAgICAgICAgICAgICAgICAgZWxlbWVudDogYXJyb3dFbGVtZW50LFxyXG4gICAgICAgICAgICAgICAgICAgIHBhZGRpbmc6IDRcclxuICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgIF0sXHJcbiAgICAgICAgfTtcclxuICAgICAgICBpZiAoIXRoaXMucG9wcGVyT3B0aW9ucy5wcmV2ZW50T3ZlcmZsb3cgJiYgIXBvcHBlck9wdGlvbnMucGxhY2VtZW50KSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGJvdW5kYXJpZXNFbGVtZW50ID0gdGhpcy5wb3BwZXJPcHRpb25zLmJvdW5kYXJpZXNFbGVtZW50ICYmIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IodGhpcy5wb3BwZXJPcHRpb25zLmJvdW5kYXJpZXNFbGVtZW50KTtcclxuICAgICAgICAgICAgcG9wcGVyT3B0aW9ucy5taWRkbGV3YXJlLnB1c2goXHJcbiAgICAgICAgICAgICAgICBhdXRvUGxhY2VtZW50KHtcclxuICAgICAgICAgICAgICAgICAgICBib3VuZGFyeTogYm91bmRhcmllc0VsZW1lbnRcclxuICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbXB1dGVQb3NpdGlvbih0aGlzLnJlZmVyZW5jZU9iamVjdCwgdGhpcy5wb3BwZXJWaWV3UmVmLm5hdGl2ZUVsZW1lbnQsIHBvcHBlck9wdGlvbnMpXHJcbiAgICAgICAgICAgIC50aGVuKCh7bWlkZGxld2FyZURhdGEsIHgsIHksIHBsYWNlbWVudH0pID0+IHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHNpZGUgPSBwbGFjZW1lbnQuc3BsaXQoXCItXCIpWzBdO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5wb3BwZXJWaWV3UmVmLm5hdGl2ZUVsZW1lbnQuc2V0QXR0cmlidXRlKFwiZGF0YS1wb3BwZXItcGxhY2VtZW50XCIsIHNpZGUpO1xyXG4gICAgICAgICAgICAgICAgaWYgKG1pZGRsZXdhcmVEYXRhLmFycm93KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3RhdGljU2lkZSA9IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdG9wOiBcImJvdHRvbVwiLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICByaWdodDogXCJsZWZ0XCIsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGJvdHRvbTogXCJ0b3BcIixcclxuICAgICAgICAgICAgICAgICAgICAgICAgbGVmdDogXCJyaWdodFwiXHJcbiAgICAgICAgICAgICAgICAgICAgfVtzaWRlXTtcclxuICAgICAgICAgICAgICAgICAgICBPYmplY3QuYXNzaWduKGFycm93RWxlbWVudC5zdHlsZSwge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBsZWZ0OiBtaWRkbGV3YXJlRGF0YS5hcnJvdy54ICE9IG51bGwgPyBgJHttaWRkbGV3YXJlRGF0YS5hcnJvdy54fXB4YCA6IFwiXCIsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRvcDogbWlkZGxld2FyZURhdGEuYXJyb3cueSAhPSBudWxsID8gYCR7bWlkZGxld2FyZURhdGEuYXJyb3cueX1weGAgOiBcIlwiLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBbc3RhdGljU2lkZV06IGAkey1hcnJvd0xlbiAvIDJ9cHhgXHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBPYmplY3QuYXNzaWduKHRoaXMucG9wcGVyVmlld1JlZi5uYXRpdmVFbGVtZW50LnN0eWxlLCB7XHJcbiAgICAgICAgICAgICAgICAgICAgbGVmdDogYCR7eH1weGAsXHJcbiAgICAgICAgICAgICAgICAgICAgdG9wOiBgJHt5fXB4YCxcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgdGhpcy50b2dnbGVWaXNpYmlsaXR5KCEwKTtcclxuICAgICAgICAgICAgICAgIHRoaXMub25VcGRhdGU/LigpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBwcm90ZWN0ZWQgX2NyZWF0ZUFycm93U2VsZWN0b3IoKTogc3RyaW5nIHtcclxuICAgICAgICByZXR1cm4gYGRpdiMke3RoaXMuaWR9Lm5neHBfX2NvbnRhaW5lciA+IC5uZ3hwX19hcnJvdy5uZ3hwX19mb3JjZS1hcnJvd2A7XHJcbiAgICB9XHJcblxyXG4gICAgcHJvdGVjdGVkIF9kZXRlcm1pbmVBcnJvd0NvbG9yKCkge1xyXG4gICAgICAgIGlmICghdGhpcy5wb3BwZXJPcHRpb25zLnN0eWxlcyB8fCB0aGlzLmFycm93Q29sb3IpIHtcclxuXHJcbiAgICAgICAgICAgIHJldHVybiAhMTtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3QgcnVsZVZhbHVlID0gdGhpcy5wb3BwZXJPcHRpb25zLnN0eWxlc1tcImJhY2tncm91bmQtY29sb3JcIl0gfHwgdGhpcy5wb3BwZXJPcHRpb25zLnN0eWxlcy5iYWNrZ3JvdW5kQ29sb3I7XHJcbiAgICAgICAgaWYgKHRoaXMuYXJyb3dDb2xvciA9PT0gcnVsZVZhbHVlKSB7XHJcbiAgICAgICAgICAgIHJldHVybiAhMTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5hcnJvd0NvbG9yID0gcnVsZVZhbHVlO1xyXG4gICAgICAgIGxldCAkc3R5bGUgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKGAjJHt0aGlzLl9zdHlsZUlkfWApIGFzIEhUTUxTdHlsZUVsZW1lbnQ7XHJcbiAgICAgICAgY29uc3Qgc3R5bGVDb250ZW50ID0gdGhpcy5hcnJvd0NvbG9yID9cclxuICAgICAgICAgICAgYCR7dGhpcy5fY3JlYXRlQXJyb3dTZWxlY3RvcigpfTpiZWZvcmUgeyBiYWNrZ3JvdW5kLWNvbG9yOiAke3RoaXMuYXJyb3dDb2xvcn07IH1gIDogXCJcIjtcclxuICAgICAgICBpZiAoISRzdHlsZSkge1xyXG4gICAgICAgICAgICAkc3R5bGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwic3R5bGVcIikgYXMgSFRNTFN0eWxlRWxlbWVudDtcclxuICAgICAgICAgICAgJHN0eWxlLmlkID0gdGhpcy5fc3R5bGVJZDtcclxuICAgICAgICAgICAgJHN0eWxlLnNldEF0dHJpYnV0ZShcInR5cGVcIiwgXCJ0ZXh0L2Nzc1wiKTtcclxuICAgICAgICAgICAgZG9jdW1lbnQuaGVhZC5hcHBlbmRDaGlsZCgkc3R5bGUpO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tc3RyaW5nLWxpdGVyYWxcclxuICAgICAgICBpZiAoJHN0eWxlW1wic3R5bGVTaGVldFwiXSkge1xyXG4gICAgICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tc3RyaW5nLWxpdGVyYWxcclxuICAgICAgICAgICAgJHN0eWxlW1wic3R5bGVTaGVldFwiXS5jc3NUZXh0ID0gc3R5bGVDb250ZW50O1xyXG4gICAgICAgICAgICAvLyBUaGlzIGlzIHJlcXVpcmVkIGZvciBJRTggYW5kIGJlbG93LlxyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgJHN0eWxlLmlubmVySFRNTCA9IHN0eWxlQ29udGVudDtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJvdGVjdGVkIF90b2dnbGVWaXNpYmlsaXR5KHN0YXRlKTogdm9pZCB7XHJcbiAgICAgICAgdGhpcy5kaXNwbGF5VHlwZSA9IFtcIm5vbmVcIiwgXCJibG9ja1wiXVsrc3RhdGVdO1xyXG4gICAgICAgIHRoaXMub3BhY2l0eSA9ICtzdGF0ZTtcclxuICAgICAgICB0aGlzLmFyaWFIaWRkZW4gPSBgJHshc3RhdGV9YDtcclxuICAgICAgICB0aGlzLnN0YXRlID0gc3RhdGU7XHJcbiAgICB9XHJcbn1cclxuIiwiPGRpdiAjcG9wcGVyVmlld1JlZlxyXG4gICAgIFthdHRyLmlkXT1cImlkXCJcclxuICAgICBbY2xhc3Mubmd4cF9fY29udGFpbmVyXT1cIiFwb3BwZXJPcHRpb25zLmRpc2FibGVEZWZhdWx0U3R5bGluZ1wiXHJcbiAgICAgW2NsYXNzLm5neHBfX2FuaW1hdGlvbl09XCIhcG9wcGVyT3B0aW9ucy5kaXNhYmxlQW5pbWF0aW9uXCJcclxuICAgICBbc3R5bGUuZGlzcGxheV09XCJkaXNwbGF5VHlwZVwiXHJcbiAgICAgW3N0eWxlLm9wYWNpdHldPVwib3BhY2l0eVwiXHJcbiAgICAgW25nU3R5bGVdPVwicG9wcGVyT3B0aW9ucy5zdHlsZXNcIlxyXG4gICAgIFtuZ0NsYXNzXT1cImV4dHJhY3RBcHBsaWVkQ2xhc3NMaXN0RXhwcihwb3BwZXJPcHRpb25zLmFwcGx5Q2xhc3MpXCJcclxuICAgICBhdHRyLmFyaWEtaGlkZGVuPVwie3thcmlhSGlkZGVufX1cIlxyXG4gICAgIFthdHRyLmFyaWEtZGVzY3JpYmVkYnldPVwicG9wcGVyT3B0aW9ucy5hcmlhRGVzY3JpYmUgfHwgbnVsbFwiXHJcbiAgICAgYXR0ci5yb2xlPVwie3twb3BwZXJPcHRpb25zLmFyaWFSb2xlfX1cIj5cclxuICAgIDxkaXYgKm5nSWY9XCJ0ZXh0XCJcclxuICAgICAgICAgY2xhc3M9XCJuZ3hwX19pbm5lclwiXHJcbiAgICAgICAgIFtpbm5lckhUTUxdPVwidGV4dFwiPlxyXG4gICAgICAgIDxuZy1jb250ZW50PjwvbmctY29udGVudD5cclxuICAgIDwvZGl2PlxyXG4gICAgPGRpdiAqbmdJZj1cIiF0ZXh0XCJcclxuICAgICAgICAgY2xhc3M9XCJuZ3hwX19pbm5lclwiPlxyXG4gICAgICAgIDxuZy1jb250ZW50PjwvbmctY29udGVudD5cclxuICAgIDwvZGl2PlxyXG4gICAgPGRpdiBjbGFzcz1cIm5neHBfX2Fycm93XCJcclxuICAgICAgICAgW2NsYXNzLm5neHBfX2ZvcmNlLWFycm93XT1cImFycm93Q29sb3JcIlxyXG4gICAgICAgICBbbmdDbGFzc109XCJleHRyYWN0QXBwbGllZENsYXNzTGlzdEV4cHIocG9wcGVyT3B0aW9ucy5hcHBseUFycm93Q2xhc3MpXCI+PC9kaXY+XHJcblxyXG48L2Rpdj5cclxuIl19